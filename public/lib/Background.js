// Generated by CoffeeScript 1.10.0
(function() {
  var makeBuffer;

  makeBuffer = function(width, height, insertAfterSelector) {
    var buffer;
    buffer = $('<canvas />')[0];
    buffer.width = width;
    buffer.height = height;
    if (insertAfterSelector) {
      $(buffer).insertAfter($(insertAfterSelector).css('display', 'inline-block')[0]).css({
        width: 768,
        height: 768,
        display: 'inline-block',
        left: 1024
      });
    }
    return buffer;
  };

  this.Background = {
    create: function(options) {
      var bgBuffer, bgSprite, binSize, chunkHeight, chunkWidth, chunkX, chunkY, ctx, ctxs, ctxsArray, doodadSpriteFrame, doodadSpriteFrameConfig, doodadSpriteFrameConfigs, doodadSpriteFrameOffset, doodadSpriteFrameRect, doodadsSpriteFrameFunction, fgBuffer, fgSprite, height, i, j, k, l, len, len1, m, modHeight, modWidth, parentSprite, ref, ref1, ref2, results, spatialHash, spriteFrame, spriteFrameOffset, spriteFrameRect, spriteFrames, tileMap, tileMapSize, tileSize, tileSpriteFrameFunction, transitionSpriteFrameFunction, width, x, y;
      this.options = options;
      tileMap = this.options.tileMap;
      tileMapSize = this.options.tileMapSize;
      tileSize = this.options.tileSize;
      parentSprite = this.options.parentSprite;
      spatialHash = this.options.spatialHash;
      tileSpriteFrameFunction = this.options.tileSpriteFrameFunction;
      transitionSpriteFrameFunction = this.options.transitionSpriteFrameFunction;
      doodadsSpriteFrameFunction = this.options.doodadsSpriteFrameFunction;
      width = tileMapSize.width;
      height = tileMapSize.height;
      this.buffer = makeBuffer(width * tileSize.width, height * tileSize.height, 'div');
      this.buffer.id = 'preview';
      ctx = this.buffer.getContext('2d');
      ctx.webkitImageSmoothingEnabled = false;
      ctx.mozImageSmoothingEnabled = false;
      ctx.imageSmoothingEnabled = false;
      ctx.oImageSmoothingEnabled = false;
      ctx.translate(0, this.buffer.height);
      if (spatialHash != null) {
        binSize = spatialHash.binSize;
      } else {
        binSize = new cc.Size(this.buffer.width, this.buffer.height);
      }
      modWidth = Math.floor(binSize.width / tileSize.width);
      modHeight = Math.floor(binSize.height / tileSize.height);
      chunkWidth = modWidth * tileSize.width;
      chunkHeight = modHeight * tileSize.height;
      ctxsArray = [];
      for (y = i = 0, ref = height; 0 <= ref ? i < ref : i > ref; y = 0 <= ref ? ++i : --i) {
        for (x = j = 0, ref1 = width; 0 <= ref1 ? j < ref1 : j > ref1; x = 0 <= ref1 ? ++j : --j) {
          chunkX = Math.floor(x / modWidth);
          if (!ctxsArray[chunkX]) {
            ctxsArray[chunkX] = [];
          }
          chunkY = Math.floor(y / modHeight);
          ctxs = ctxsArray[chunkX][chunkY];
          if (!ctxs) {
            bgBuffer = makeBuffer(chunkWidth, chunkHeight);
            fgBuffer = makeBuffer(chunkWidth + 2 * tileSize.width, chunkHeight);
            bgSprite = new Tile({
              buffer: bgBuffer,
              spatialHash: spatialHash,
              order: 0
            });
            fgSprite = new Tile({
              buffer: fgBuffer,
              spatialHash: spatialHash,
              order: 0
            });
            bgSprite.setAnchorPoint(new cc.Point(0, 1));
            fgSprite.setAnchorPoint(new cc.Point(0, 1));
            bgSprite.setPosition(new cc.Point(chunkX * chunkWidth, chunkY * chunkHeight));
            fgSprite.setPosition(new cc.Point(chunkX * chunkWidth - tileSize.width, chunkY * chunkHeight));
            bgSprite.setScaleY(-1);
            fgSprite.setScaleY(-1);
            parentSprite.addChild(bgSprite, 0);
            parentSprite.addChild(fgSprite, 2);
            if (spatialHash != null) {
              spatialHash.addNode(bgSprite);
              spatialHash.addNode(fgSprite);
            }
            bgSprite = new Tile({
              buffer: bgBuffer,
              spatialHash: spatialHash
            });
            fgSprite = new Tile({
              buffer: fgBuffer,
              spatialHash: spatialHash
            });
            bgSprite.setAnchorPoint(new cc.Point(0, 1));
            fgSprite.setAnchorPoint(new cc.Point(0, 1));
            bgSprite.setPosition(new cc.Point(chunkX * chunkWidth + this.buffer.width, chunkY * chunkHeight));
            fgSprite.setPosition(new cc.Point(chunkX * chunkWidth + this.buffer.width - tileSize.width, chunkY * chunkHeight));
            bgSprite.setScaleY(-1);
            fgSprite.setScaleY(-1);
            parentSprite.addChild(bgSprite, 0);
            parentSprite.addChild(fgSprite, 2);
            if (spatialHash != null) {
              spatialHash.addNode(bgSprite);
              spatialHash.addNode(fgSprite);
            }
            ctxs = ctxsArray[chunkX][chunkY] = {
              bg: bgBuffer.getContext('2d'),
              fg: fgBuffer.getContext('2d')
            };
          }
          spriteFrames = tileSpriteFrameFunction(x, y, tileMap);
          for (k = 0, len = spriteFrames.length; k < len; k++) {
            spriteFrame = spriteFrames[k];
            if (spriteFrame != null) {
              spriteFrameRect = spriteFrame.getRect();
              spriteFrameOffset = spriteFrame.getOffset();
              ctxs.bg.drawImage(spriteFrame.getTexture(), spriteFrameRect.origin.x, spriteFrameRect.origin.y, spriteFrameRect.size.width, spriteFrameRect.size.height, (x % modWidth) * tileSize.width - spriteFrameOffset.x, (y % modHeight) * tileSize.height - spriteFrameOffset.y, spriteFrameRect.size.width, spriteFrameRect.size.height);
              ctx.drawImage(spriteFrame.getTexture(), spriteFrameRect.origin.x, spriteFrameRect.origin.y, spriteFrameRect.size.width, spriteFrameRect.size.height, x * tileSize.width - spriteFrameOffset.x, y * tileSize.height - this.buffer.height - spriteFrameOffset.y, spriteFrameRect.size.width, spriteFrameRect.size.height);
            }
          }
          spriteFrames = transitionSpriteFrameFunction(x, y, tileMap);
          for (l = 0, len1 = spriteFrames.length; l < len1; l++) {
            spriteFrame = spriteFrames[l];
            if (spriteFrame != null) {
              spriteFrameRect = spriteFrame.getRect();
              spriteFrameOffset = spriteFrame.getOffset();
              ctxs.bg.drawImage(spriteFrame.getTexture(), spriteFrameRect.origin.x, spriteFrameRect.origin.y, spriteFrameRect.size.width, spriteFrameRect.size.height, (x % modWidth) * tileSize.width - spriteFrameOffset.x, (y % modHeight) * tileSize.height - spriteFrameOffset.y, spriteFrameRect.size.width, spriteFrameRect.size.height);
              ctx.drawImage(spriteFrame.getTexture(), spriteFrameRect.origin.x, spriteFrameRect.origin.y, spriteFrameRect.size.width, spriteFrameRect.size.height, x * tileSize.width - spriteFrameOffset.x, y * tileSize.height - this.buffer.height - spriteFrameOffset.y, spriteFrameRect.size.width, spriteFrameRect.size.height);
            }
          }
        }
      }
      results = [];
      for (y = m = 0, ref2 = height; 0 <= ref2 ? m < ref2 : m > ref2; y = 0 <= ref2 ? ++m : --m) {
        results.push((function() {
          var len2, n, o, ref3, results1;
          results1 = [];
          for (x = n = 0, ref3 = width; 0 <= ref3 ? n < ref3 : n > ref3; x = 0 <= ref3 ? ++n : --n) {
            doodadSpriteFrameConfigs = doodadsSpriteFrameFunction(x, y, tileMap);
            for (o = 0, len2 = doodadSpriteFrameConfigs.length; o < len2; o++) {
              doodadSpriteFrameConfig = doodadSpriteFrameConfigs[o];
              doodadSpriteFrame = doodadSpriteFrameConfig.spriteFrame;
              doodadSpriteFrameOffset = doodadSpriteFrame.getOffset();
              doodadSpriteFrameConfig.x = doodadSpriteFrameConfig.x - doodadSpriteFrameOffset.x + tileSize.width;
              if (doodadSpriteFrameConfig.z == null) {
                doodadSpriteFrameConfig.z = doodadSpriteFrameConfig.y;
              }
              doodadSpriteFrameConfig.y = doodadSpriteFrameConfig.z - doodadSpriteFrameOffset.y;
            }
            doodadSpriteFrameConfigs.sort(function(a, b) {
              return a.z - b.z;
            });
            results1.push((function() {
              var len3, p, results2;
              results2 = [];
              for (p = 0, len3 = doodadSpriteFrameConfigs.length; p < len3; p++) {
                doodadSpriteFrameConfig = doodadSpriteFrameConfigs[p];
                doodadSpriteFrame = doodadSpriteFrameConfig.spriteFrame;
                doodadSpriteFrameRect = doodadSpriteFrame.getRect();
                ctxs.fg.drawImage(doodadSpriteFrame.getTexture(), doodadSpriteFrameRect.origin.x, doodadSpriteFrameRect.origin.y, doodadSpriteFrameRect.size.width, doodadSpriteFrameRect.size.height, (x % modWidth) * tileSize.width + doodadSpriteFrameConfig.x, (y % modHeight) * tileSize.height + doodadSpriteFrameConfig.y, doodadSpriteFrameRect.size.width, doodadSpriteFrameRect.size.height);
                results2.push(ctx.drawImage(doodadSpriteFrame.getTexture(), doodadSpriteFrameRect.origin.x, doodadSpriteFrameRect.origin.y, doodadSpriteFrameRect.size.width, doodadSpriteFrameRect.size.height, x * tileSize.width + doodadSpriteFrameConfig.x - tileSize.width, y * tileSize.height - this.buffer.height + doodadSpriteFrameConfig.y, doodadSpriteFrameRect.size.width, doodadSpriteFrameRect.size.height));
              }
              return results2;
            }).call(this));
          }
          return results1;
        }).call(this));
      }
      return results;
    }
  };

}).call(this);
